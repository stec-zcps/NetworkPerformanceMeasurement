# Sockperf

## Setup
To use Sockperf as external tool [installation](https://github.com/Mellanox/sockperf) is required.

### Installation on Debian-based systems
```bash
sudo apt install -y perl make automake autoconf m4 libtool-bin g++
git clone https://github.com/Mellanox/sockperf.git && 
cd sockperf &&
git checkout 3.7 && 
./autogen.sh &&
./configure --prefix=/opt/sockperf &&
make -j4 &&
sudo make install &&
cd .. && sudo rm -r sockperf &&
sudo ln -s /opt/sockperf/bin/sockperf /usr/local/bin/sockperf
```

## Usage
## Ping Pong Mode
Sample command using tcp:
```bash
dotnet run -- sockperf ping-pong --serverIp 127.0.0.1 --clientIp 127.0.0.1 --port 11111 --time 1 --msgs-per-sec 100,500 --msg-size 500 --tcp --transmissionTechnology "Loopback" --comment "Test Comment 3"
```

Sample command using udp:
```bash
dotnet run -- sockperf ping-pong --serverIp 127.0.0.1 --clientIp 127.0.0.1 --port 11111 --time 1 --msgs-per-sec 100,500 --msg-size 500 --udp --transmissionTechnology "Loopback" --comment "Test Comment 3" 
```

## Playback Mode
Sample command using tcp:
```bash
dotnet run -- sockperf playback --transmissionTechnology "Loopback" --serverIp 127.0.0.1 --clientIp 127.0.0.1 --tcp --files test.pfile,test.pfile 
```
Playback files can be e.g. generated using awk script:
```bash
 #!/usr/bin/awk -f
BEGIN {
        print "# ==== playback file for sockperf - generated by gen1.awk ===="
        PPS = 10
        NUM_RECORDS = PPS*5 # 30*1000
        runtime = 5
        interval = 1/PPS
        baseTime = 2
        printf "#baseTime=%f; PPS=%d; runtime=%f; interval=%lf; NUM_RECORDS=%d\n", baseTime, PPS, runtime, interval, NUM_RECORDS
        deltaSize = 0
        minSize = 14
        maxSize = 50000 - minSize
        t = baseTime
        s = 0
        printf "# file contains %d records\n", NUM_RECORDS
        for (i = 0; i < NUM_RECORDS; i++) {
                t += interval
                s += deltaSize
                printf("%.9lf, %d\n", t, minSize+s%maxSize)
        }
        printf "#%d records were written successfuly\n", NUM_RECORDS
}
```
